<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drift — Browse Freely</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0c0c14;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #e0e0e8;
      overflow: hidden;
    }

    /* ─── Top bar ─── */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: #121220;
      border-bottom: 1px solid #1e1e30;
      flex-shrink: 0;
    }

    .brand {
      flex-shrink: 0;
      user-select: none;
      display: flex;
      align-items: center;
    }

    .brand-logo {
      height: 24px;
      width: auto;
    }

    .nav-buttons {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .nav-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: none;
      color: #666;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
      font-family: inherit;
    }

    .nav-btn:hover:not(:disabled) {
      background: #1a1a2e;
      color: #e0e0e8;
    }

    .nav-btn:disabled {
      opacity: 0.25;
      cursor: default;
    }

    .url-bar {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1a1a2e;
      border: 1px solid #2a2a44;
      border-radius: 10px;
      padding: 0 6px 0 14px;
      transition: border-color 0.2s;
    }

    .url-bar:focus-within {
      border-color: #3b82f6;
    }

    .url-bar input {
      flex: 1;
      background: none;
      border: none;
      color: #e0e0e8;
      font-size: 0.88rem;
      padding: 9px 0;
      outline: none;
      font-family: inherit;
    }

    .url-bar input::placeholder {
      color: #555570;
    }

    .url-bar button[type="submit"] {
      background: linear-gradient(135deg, #5eead4, #3b82f6);
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 7px;
      cursor: pointer;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .url-bar button:hover {
      opacity: 0.85;
    }

    /* ─── Tab bar ─── */
    .tab-bar {
      display: flex;
      align-items: end;
      gap: 2px;
      padding: 0 12px;
      background: #0f0f1a;
      border-bottom: 1px solid #1e1e30;
      flex-shrink: 0;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .tab-bar::-webkit-scrollbar {
      display: none;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #14142a;
      border: 1px solid #1e1e30;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-size: 0.78rem;
      color: #888;
      max-width: 200px;
      min-width: 80px;
      transition: background 0.15s, color 0.15s;
      user-select: none;
      flex-shrink: 0;
    }

    .tab:hover {
      background: #1a1a34;
      color: #bbb;
    }

    .tab.dragging {
      opacity: 0.4;
    }

    .tab.drag-over-left {
      box-shadow: inset 3px 0 0 #3b82f6;
    }

    .tab.drag-over-right {
      box-shadow: inset -3px 0 0 #3b82f6;
    }

    .tab.active {
      background: #1a1a2e;
      color: #e0e0e8;
      border-color: #2a2a44;
    }

    .tab-favicon {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      flex-shrink: 0;
      display: none;
    }

    .tab-favicon.loaded {
      display: block;
    }

    .tab-title {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    .tab-close {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      line-height: 1;
      color: #555;
      flex-shrink: 0;
      transition: background 0.15s, color 0.15s;
    }

    .tab-close:hover {
      background: rgba(255, 80, 80, 0.2);
      color: #ff6b6b;
    }

    .new-tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      margin-bottom: 4px;
      border-radius: 8px;
      background: none;
      border: 1px solid transparent;
      color: #555;
      font-size: 18px;
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .new-tab-btn:hover {
      background: #1a1a34;
      border-color: #2a2a44;
      color: #aaa;
    }

    /* ─── Content area ─── */
    .content {
      flex: 1;
      position: relative;
      background: #0c0c14;
    }

    .tab-panel {
      position: absolute;
      inset: 0;
      display: none;
    }

    .tab-panel.active {
      display: flex;
      flex-direction: column;
    }

    .tab-panel iframe {
      width: 100%;
      flex: 1;
      border: none;
      background: #fff;
    }

    /* ─── Loading bar ─── */
    .loading-bar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      z-index: 10;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .loading-bar.active {
      opacity: 1;
    }

    .loading-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -40%;
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, transparent, #5eead4, #3b82f6, transparent);
      animation: loading-slide 1.2s ease-in-out infinite;
    }

    @keyframes loading-slide {
      0% { left: -40%; }
      100% { left: 100%; }
    }

    /* ─── Landing page (shown in new tabs) ─── */
    .landing {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 40px;
    }

    .landing-logo {
      height: 64px;
      width: auto;
      filter: drop-shadow(0 8px 24px rgba(59, 130, 246, 0.3));
    }

    .landing h2 {
      font-size: 1.6rem;
      font-weight: 700;
      background: linear-gradient(135deg, #5eead4, #3b82f6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .landing p {
      color: #555570;
      font-size: 0.9rem;
      max-width: 380px;
      text-align: center;
      line-height: 1.5;
    }

    .shortcuts {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .shortcut {
      padding: 8px 16px;
      background: #14142a;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #888;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .shortcut:hover {
      border-color: #3b82f6;
      color: #5eead4;
    }

    .landing-section {
      width: 100%;
      max-width: 460px;
    }

    .landing-section-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #444;
      margin-bottom: 8px;
    }

    /* ─── Bookmark button ─── */
    .bookmark-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: none;
      color: #555;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s, transform 0.15s;
      flex-shrink: 0;
      font-family: inherit;
      line-height: 1;
    }

    .bookmark-btn:hover {
      color: #facc15;
    }

    .bookmark-btn.active {
      color: #facc15;
    }

    .bookmark-btn.active:hover {
      color: #fbbf24;
    }

    /* ─── Bookmark items on landing ─── */
    .bookmark-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #14142a;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #888;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      max-width: 100%;
    }

    .bookmark-item:hover {
      border-color: #3b82f6;
      color: #5eead4;
    }

    .bookmark-item-title {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    .bookmark-item-remove {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #444;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.15s, color 0.15s, background 0.15s;
    }

    .bookmark-item:hover .bookmark-item-remove {
      opacity: 1;
    }

    .bookmark-item-remove:hover {
      background: rgba(255, 80, 80, 0.2);
      color: #ff6b6b;
    }

    .bookmarks-grid {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .bookmarks-empty {
      font-size: 0.75rem;
      color: #333;
      margin-top: 8px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
      flex-shrink: 0;
    }

    .shield-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #5eead4;
      margin-left: 8px;
    }

    .shield-indicator svg {
      flex-shrink: 0;
    }

    .shield-count {
      font-variant-numeric: tabular-nums;
    }

    .https-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: 10px;
      cursor: pointer;
      color: #444;
      transition: color 0.2s;
      user-select: none;
      border: none;
      background: none;
      font-family: inherit;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .https-toggle:hover {
      color: #888;
    }

    .https-toggle.active {
      color: #5eead4;
    }

    .https-toggle svg {
      flex-shrink: 0;
    }

    .clear-session-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: 10px;
      cursor: pointer;
      color: #444;
      transition: color 0.2s;
      border: none;
      background: none;
      font-family: inherit;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .clear-session-btn:hover {
      color: #ff6b6b;
    }

    .clear-session-btn svg {
      flex-shrink: 0;
    }

    .clear-session-btn.flash {
      color: #5eead4;
      transition: none;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 16px;
      background: #0a0a12;
      border-top: 1px solid #1e1e30;
      font-size: 0.7rem;
      color: #444;
      flex-shrink: 0;
    }

    kbd {
      background: #1a1a2e;
      border: 1px solid #2a2a44;
      border-radius: 4px;
      padding: 1px 5px;
      font-size: 0.68rem;
      font-family: inherit;
      color: #666;
    }

    /* ─── Settings button ─── */
    .settings-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: 10px;
      cursor: pointer;
      color: #444;
      transition: color 0.2s;
      border: none;
      background: none;
      font-family: inherit;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .settings-btn:hover { color: #888; }
    .settings-btn.active { color: #5eead4; }
    .settings-btn svg { flex-shrink: 0; }

    /* ─── Settings panel ─── */
    .settings-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 900;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s, visibility 0.25s;
    }

    .settings-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 380px;
      max-width: 90vw;
      background: #121220;
      border-left: 1px solid #1e1e30;
      z-index: 910;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .settings-panel.open {
      transform: translateX(0);
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #1e1e30;
      flex-shrink: 0;
    }

    .settings-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #e0e0e8;
    }

    .settings-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }

    .settings-close:hover {
      background: #1a1a2e;
      color: #e0e0e8;
    }

    .settings-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px 20px 20px;
      scrollbar-width: thin;
      scrollbar-color: #2a2a44 transparent;
    }

    .settings-body::-webkit-scrollbar { width: 6px; }
    .settings-body::-webkit-scrollbar-track { background: transparent; }
    .settings-body::-webkit-scrollbar-thumb { background: #2a2a44; border-radius: 3px; }

    .settings-section { margin-bottom: 20px; }

    .settings-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #555570;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #1a1a2e;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      gap: 12px;
    }

    .settings-row + .settings-row {
      border-top: 1px solid #1a1a2e;
    }

    .settings-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }

    .settings-label-text {
      font-size: 0.82rem;
      color: #e0e0e8;
    }

    .settings-label-desc {
      font-size: 0.7rem;
      color: #555570;
      line-height: 1.4;
    }

    .settings-toggle {
      position: relative;
      width: 38px;
      height: 20px;
      flex-shrink: 0;
      cursor: pointer;
    }

    .settings-toggle input { display: none; }

    .settings-toggle .toggle-track {
      position: absolute;
      inset: 0;
      background: #2a2a44;
      border-radius: 10px;
      transition: background 0.2s;
    }

    .settings-toggle input:checked + .toggle-track {
      background: #5eead4;
    }

    .settings-toggle .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #e0e0e8;
      border-radius: 50%;
      transition: transform 0.2s;
      pointer-events: none;
    }

    .settings-toggle input:checked ~ .toggle-thumb {
      transform: translateX(18px);
    }

    .settings-select {
      background: #1a1a2e;
      border: 1px solid #2a2a44;
      border-radius: 7px;
      color: #e0e0e8;
      font-size: 0.8rem;
      font-family: inherit;
      padding: 6px 10px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
      flex-shrink: 0;
      min-width: 130px;
    }

    .settings-select:focus { border-color: #3b82f6; }
    .settings-select option { background: #1a1a2e; color: #e0e0e8; }

    /* ─── Compact mode ─── */
    body.compact .topbar { padding: 6px 12px; gap: 8px; }
    body.compact .url-bar input { padding: 6px 0; font-size: 0.82rem; }
    body.compact .tab { padding: 5px 10px; font-size: 0.72rem; }
    body.compact .tab-bar { padding: 0 8px; }
    body.compact .status-bar { padding: 2px 12px; font-size: 0.65rem; }

    /* ─── Font size overrides ─── */
    body.font-small .url-bar input { font-size: 0.8rem; }
    body.font-small .tab { font-size: 0.7rem; }
    body.font-small .status-bar { font-size: 0.63rem; }
    body.font-small .landing h2 { font-size: 1.3rem; }
    body.font-small .landing p { font-size: 0.8rem; }

    body.font-large .url-bar input { font-size: 0.96rem; }
    body.font-large .tab { font-size: 0.86rem; }
    body.font-large .status-bar { font-size: 0.78rem; }
    body.font-large .landing h2 { font-size: 1.8rem; }
    body.font-large .landing p { font-size: 1rem; }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand">
      <img class="brand-logo" src="/drift.svg" alt="Drift">
    </div>
    <div class="nav-buttons">
      <button class="nav-btn" id="backBtn" title="Back" disabled><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 10L8 14L6 14L0 8L6 2L8 2L8 6L16 6L16 10L8 10Z"/></svg></button>
      <button class="nav-btn" id="fwdBtn" title="Forward" disabled><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 6L8 2L10 2L16 8L10 14L8 14L8 10L0 10L0 6L8 6Z"/></svg></button>
    </div>
    <form class="url-bar" id="urlForm">
      <input
        type="text"
        id="urlInput"
        placeholder="Search DuckDuckGo or enter a URL..."
        required
        autocomplete="off"
      >
      <button type="button" class="bookmark-btn" id="bookmarkBtn" title="Bookmark this page"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M9 0H7L5.513 4.577H.701L.082 6.479 3.976 9.308 2.489 13.884l1.618 1.176L8 12.231l3.893 2.829 1.618-1.176-1.487-4.576 3.893-2.829-.618-1.902H10.487L9 0Z"/></svg></button>
      <button type="submit" title="Go"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M7.293 13.293 12.586 8 7.293 2.707l1.414-1.414L15.414 8l-6.707 6.707-1.414-1.414Z"/><path d="M.793 13.293 6.086 8 .793 2.707 2.207 1.293 8.914 8l-6.707 6.707-1.414-1.414Z"/></svg></button>
    </form>
  </div>

  <!-- Tab bar -->
  <div class="tab-bar" id="tabBar">
    <button class="new-tab-btn" id="newTabBtn" title="New tab"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M10 1H6V6L1 6V10H6V15H10V10H15V6L10 6V1Z"/></svg></button>
  </div>

  <!-- Content panels -->
  <div class="content" id="content"></div>

  <!-- Status bar -->
  <div class="status-bar">
    <div class="status-dot"></div>
    <span>Proxy active</span>
    <span class="shield-indicator"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0L1 3v5c0 4.25 2.985 8.215 7 9 4.015-.785 7-4.75 7-9V3L8 0Zm0 2.18L13 4.5v3.5c0 3.28-2.167 6.35-5 7.16-2.833-.81-5-3.88-5-7.16V4.5L8 2.18Z"/><path d="m6.5 10.793 4.646-4.647 1.061 1.061L6.5 12.914 3.793 10.207l1.061-1.06L6.5 10.793Z"/></svg><span class="shield-count" id="blockedCount">0 blocked</span></span>
    <button class="https-toggle active" id="httpsToggle" title="HTTPS-Only Mode"><svg width="10" height="12" viewBox="0 0 12 16" fill="currentColor"><path d="M6 0C3.79 0 2 1.79 2 4v2H1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1h-1V4c0-2.21-1.79-4-4-4Zm0 2c1.1 0 2 .9 2 2v2H4V4c0-1.1.9-2 2-2Zm0 8a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>HTTPS</button>
    <button class="clear-session-btn" id="clearSessionBtn" title="Clear session data (Ctrl+Shift+Delete)"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M5 2V1a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1h4v2H1V2h4Zm1 0h4V1H6v1ZM2 5h12l-.8 10a1 1 0 0 1-1 1H3.8a1 1 0 0 1-1-1L2 5Zm3.5 2v6h1V7h-1Zm4 0v6h1V7h-1Z"/></svg>Clear</button>
    <button class="settings-btn" id="settingsBtn" title="Settings (Ctrl+,)"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M6.5.5h3l.4 1.8a5.5 5.5 0 0 1 1.3.7l1.8-.6 1.5 2.6-1.4 1.2a5.6 5.6 0 0 1 0 1.5l1.4 1.2-1.5 2.6-1.8-.6a5.5 5.5 0 0 1-1.3.7L9.5 13.5h-3l-.4-1.8a5.5 5.5 0 0 1-1.3-.7l-1.8.6-1.5-2.6 1.4-1.2a5.6 5.6 0 0 1 0-1.5L1.5 5.1 3 2.5l1.8.6a5.5 5.5 0 0 1 1.3-.7L6.5.5ZM8 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z"/></svg>Settings</button>
    <span style="margin-left:auto;"><kbd>Enter</kbd> navigate &nbsp; <kbd>Ctrl+T</kbd> new tab &nbsp; <kbd>Ctrl+W</kbd> close &nbsp; <kbd>Ctrl+D</kbd> bookmark &nbsp; <kbd>Ctrl+,</kbd> settings</span>
  </div>

  <!-- Settings panel -->
  <div class="settings-backdrop" id="settingsBackdrop"></div>
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h3>Settings</h3>
      <button class="settings-close" id="settingsClose" title="Close settings"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M5.172 8L1.086 3.914 3.914 1.086 8 5.172l4.086-4.086 2.828 2.828L10.828 8l4.086 4.086-2.828 2.828L8 10.828l-4.086 4.086-2.828-2.828L5.172 8Z"/></svg></button>
    </div>
    <div class="settings-body">
      <div class="settings-section">
        <div class="settings-section-title">Search Engine</div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Default search engine</span>
            <span class="settings-label-desc">Used when you type a search query in the URL bar</span>
          </div>
          <select class="settings-select" id="settingSearchEngine">
            <option value="duckduckgo">DuckDuckGo</option>
            <option value="google">Google</option>
            <option value="bing">Bing</option>
            <option value="brave">Brave</option>
            <option value="startpage">Startpage</option>
          </select>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Privacy</div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">HTTPS-Only Mode</span>
            <span class="settings-label-desc">Automatically upgrade HTTP requests to HTTPS</span>
          </div>
          <label class="settings-toggle"><input type="checkbox" id="settingHttpsOnly"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Ad &amp; Tracker Blocking</span>
            <span class="settings-label-desc">Block known advertising and tracking domains</span>
          </div>
          <label class="settings-toggle"><input type="checkbox" id="settingAdBlock"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Auto-clear session on startup</span>
            <span class="settings-label-desc">Clear cookies and storage each time Drift loads</span>
          </div>
          <label class="settings-toggle"><input type="checkbox" id="settingAutoClear"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Tabs</div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Restore tabs on startup</span>
            <span class="settings-label-desc">Reopen your previous tabs when Drift starts</span>
          </div>
          <label class="settings-toggle"><input type="checkbox" id="settingRestoreTabs"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Close window with last tab</span>
            <span class="settings-label-desc">Show a blank page instead of opening a new tab</span>
          </div>
          <label class="settings-toggle"><input type="checkbox" id="settingCloseWithLastTab"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Compact mode</span>
            <span class="settings-label-desc">Reduce padding in the topbar and tab bar</span>
          </div>
          <label class="settings-toggle"><input type="checkbox" id="settingCompact"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="settings-row">
          <div class="settings-label">
            <span class="settings-label-text">Font size</span>
            <span class="settings-label-desc">Adjust the UI text size</span>
          </div>
          <select class="settings-select" id="settingFontSize">
            <option value="small">Small</option>
            <option value="default" selected>Default</option>
            <option value="large">Large</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Prevent Drift from being embedded inside its own iframe
    if (window !== window.top) {
      window.parent.postMessage({ type: 'drift-close' }, '*');
      document.documentElement.innerHTML = '';
      throw new Error('nested');
    }

    const tabBar = document.getElementById('tabBar');
    const newTabBtn = document.getElementById('newTabBtn');
    const content = document.getElementById('content');
    const urlForm = document.getElementById('urlForm');
    const urlInput = document.getElementById('urlInput');
    const backBtn = document.getElementById('backBtn');
    const fwdBtn = document.getElementById('fwdBtn');
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    const blockedCountEl = document.getElementById('blockedCount');
    const httpsToggle = document.getElementById('httpsToggle');
    const clearSessionBtn = document.getElementById('clearSessionBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsClose = document.getElementById('settingsClose');
    const settingSearchEngine = document.getElementById('settingSearchEngine');
    const settingHttpsOnly = document.getElementById('settingHttpsOnly');
    const settingAdBlock = document.getElementById('settingAdBlock');
    const settingAutoClear = document.getElementById('settingAutoClear');
    const settingRestoreTabs = document.getElementById('settingRestoreTabs');
    const settingCloseWithLastTab = document.getElementById('settingCloseWithLastTab');
    const settingCompact = document.getElementById('settingCompact');
    const settingFontSize = document.getElementById('settingFontSize');

    // ─── Settings panel open/close ───
    function openSettings() {
      settingsBackdrop.classList.add('open');
      settingsPanel.classList.add('open');
      settingsBtn.classList.add('active');
    }
    function closeSettings() {
      settingsBackdrop.classList.remove('open');
      settingsPanel.classList.remove('open');
      settingsBtn.classList.remove('active');
    }
    settingsBtn.addEventListener('click', () => {
      settingsPanel.classList.contains('open') ? closeSettings() : openSettings();
    });
    settingsClose.addEventListener('click', closeSettings);
    settingsBackdrop.addEventListener('click', closeSettings);

    // ─── Search engine setting ───
    const SEARCH_ENGINES = {
      duckduckgo: { url: 'https://duckduckgo.com/?q=', placeholder: 'Search DuckDuckGo or enter a URL...' },
      google:     { url: 'https://www.google.com/search?q=', placeholder: 'Search Google or enter a URL...' },
      bing:       { url: 'https://www.bing.com/search?q=', placeholder: 'Search Bing or enter a URL...' },
      brave:      { url: 'https://search.brave.com/search?q=', placeholder: 'Search Brave or enter a URL...' },
      startpage:  { url: 'https://www.startpage.com/do/search?q=', placeholder: 'Search Startpage or enter a URL...' },
    };
    let currentSearchEngine = localStorage.getItem('drift-search-engine') || 'duckduckgo';
    settingSearchEngine.value = currentSearchEngine;
    urlInput.placeholder = SEARCH_ENGINES[currentSearchEngine].placeholder;
    settingSearchEngine.addEventListener('change', () => {
      currentSearchEngine = settingSearchEngine.value;
      localStorage.setItem('drift-search-engine', currentSearchEngine);
      urlInput.placeholder = SEARCH_ENGINES[currentSearchEngine].placeholder;
    });

    // ─── Ad blocking setting ───
    let adBlockEnabled = localStorage.getItem('drift-adblock') !== 'false'; // default on
    settingAdBlock.checked = adBlockEnabled;
    function syncAdBlock() {
      fetch('/adblock', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: adBlockEnabled }) }).catch(() => {});
    }
    syncAdBlock(); // sync on startup
    settingAdBlock.addEventListener('change', () => {
      adBlockEnabled = settingAdBlock.checked;
      localStorage.setItem('drift-adblock', adBlockEnabled);
      document.querySelector('.shield-indicator').style.display = adBlockEnabled ? '' : 'none';
      syncAdBlock();
    });
    if (!adBlockEnabled) document.querySelector('.shield-indicator').style.display = 'none';

    function proxyUrl(url) {
      return '/proxy/' + encodeURIComponent(url);
    }

    // ─── Compact mode ───
    let compactMode = localStorage.getItem('drift-compact') === 'true';
    settingCompact.checked = compactMode;
    function applyCompactMode() { document.body.classList.toggle('compact', compactMode); }
    applyCompactMode();
    settingCompact.addEventListener('change', () => {
      compactMode = settingCompact.checked;
      localStorage.setItem('drift-compact', compactMode);
      applyCompactMode();
    });

    // ─── Font size ───
    let fontSize = localStorage.getItem('drift-font-size') || 'default';
    settingFontSize.value = fontSize;
    function applyFontSize() {
      document.body.classList.remove('font-small', 'font-large');
      if (fontSize !== 'default') document.body.classList.add('font-' + fontSize);
    }
    applyFontSize();
    settingFontSize.addEventListener('change', () => {
      fontSize = settingFontSize.value;
      localStorage.setItem('drift-font-size', fontSize);
      applyFontSize();
    });

    // Poll blocked count from server
    setInterval(() => {
      fetch('/blocked-count').then(r => r.json()).then(d => {
        blockedCountEl.textContent = d.count + ' blocked';
      }).catch(() => {});
    }, 3000);

    // ─── HTTPS-Only Mode (persisted in localStorage) ───
    let httpsOnly = localStorage.getItem('drift-https-only') !== 'false'; // default on
    httpsToggle.classList.toggle('active', httpsOnly);
    settingHttpsOnly.checked = httpsOnly;
    httpsToggle.addEventListener('click', () => {
      httpsOnly = !httpsOnly;
      localStorage.setItem('drift-https-only', httpsOnly);
      httpsToggle.classList.toggle('active', httpsOnly);
      settingHttpsOnly.checked = httpsOnly;
    });
    settingHttpsOnly.addEventListener('change', () => {
      httpsOnly = settingHttpsOnly.checked;
      localStorage.setItem('drift-https-only', httpsOnly);
      httpsToggle.classList.toggle('active', httpsOnly);
    });

    function enforceHttps(url) {
      if (httpsOnly && url.startsWith('http://')) {
        return url.replace(/^http:\/\//, 'https://');
      }
      return url;
    }

    // ─── Session isolation ───
    const DRIFT_KEYS = [
      'drift-bookmarks', 'drift-https-only', 'drift-search-engine',
      'drift-adblock', 'drift-auto-clear', 'drift-restore-tabs',
      'drift-close-with-last-tab', 'drift-compact', 'drift-font-size',
      'drift-saved-tabs'
    ];

    function clearSessionData() {
      // Clear all localStorage except Drift's own keys
      const keep = {};
      DRIFT_KEYS.forEach(k => { const v = localStorage.getItem(k); if (v !== null) keep[k] = v; });
      localStorage.clear();
      Object.entries(keep).forEach(([k, v]) => localStorage.setItem(k, v));

      // Clear sessionStorage entirely
      sessionStorage.clear();

      // Clear cookies
      document.cookie.split(';').forEach(c => {
        const name = c.split('=')[0].trim();
        if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
      });

      // Clear caches API
      if (window.caches) {
        caches.keys().then(names => names.forEach(n => caches.delete(n))).catch(() => {});
      }

      // Visual flash on button
      clearSessionBtn.classList.add('flash');
      setTimeout(() => clearSessionBtn.classList.remove('flash'), 400);
    }

    // ─── Auto-clear session on startup ───
    let autoClearOnStartup = localStorage.getItem('drift-auto-clear') !== 'false'; // default on
    settingAutoClear.checked = autoClearOnStartup;
    settingAutoClear.addEventListener('change', () => {
      autoClearOnStartup = settingAutoClear.checked;
      localStorage.setItem('drift-auto-clear', autoClearOnStartup);
    });

    if (autoClearOnStartup) clearSessionData();

    clearSessionBtn.addEventListener('click', clearSessionData);

    let tabs = [];
    let activeTabId = null;
    let tabCounter = 0;

    // ─── Tab settings ───
    let restoreTabsOnStartup = localStorage.getItem('drift-restore-tabs') === 'true'; // default off
    settingRestoreTabs.checked = restoreTabsOnStartup;
    settingRestoreTabs.addEventListener('change', () => {
      restoreTabsOnStartup = settingRestoreTabs.checked;
      localStorage.setItem('drift-restore-tabs', restoreTabsOnStartup);
    });

    let closeWithLastTab = localStorage.getItem('drift-close-with-last-tab') === 'true'; // default off
    settingCloseWithLastTab.checked = closeWithLastTab;
    settingCloseWithLastTab.addEventListener('change', () => {
      closeWithLastTab = settingCloseWithLastTab.checked;
      localStorage.setItem('drift-close-with-last-tab', closeWithLastTab);
    });

    function saveTabState() {
      if (!restoreTabsOnStartup) return;
      const tabState = tabs.filter(t => t.url).map(t => ({ url: t.url, title: t.title }));
      localStorage.setItem('drift-saved-tabs', JSON.stringify(tabState));
    }

    // ─── Bookmarks (persisted in localStorage) ───
    function loadBookmarks() {
      try { return JSON.parse(localStorage.getItem('drift-bookmarks')) || []; } catch { return []; }
    }
    function saveBookmarks(bm) {
      localStorage.setItem('drift-bookmarks', JSON.stringify(bm));
    }
    function isBookmarked(url) {
      return loadBookmarks().some(b => b.url === url);
    }
    function updateBookmarkBtn() {
      const tab = tabs.find(t => t.id === activeTabId);
      bookmarkBtn.classList.toggle('active', !!(tab && tab.url && isBookmarked(tab.url)));
    }
    function toggleBookmark() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || !tab.url) return;
      const bm = loadBookmarks();
      const idx = bm.findIndex(b => b.url === tab.url);
      if (idx !== -1) {
        bm.splice(idx, 1);
      } else {
        bm.push({ title: tab.title || tab.url, url: tab.url });
      }
      saveBookmarks(bm);
      updateBookmarkBtn();
      refreshLandings();
    }
    function removeBookmark(url) {
      const bm = loadBookmarks();
      const idx = bm.findIndex(b => b.url === url);
      if (idx !== -1) {
        bm.splice(idx, 1);
        saveBookmarks(bm);
        updateBookmarkBtn();
        refreshLandings();
      }
    }
    function refreshLandings() {
      document.querySelectorAll('.tab-panel').forEach(p => {
        if (p.querySelector('.landing')) {
          p.innerHTML = buildLanding();
        }
      });
    }

    const SHORTCUTS = [
      { label: 'Wikipedia', url: 'https://en.wikipedia.org' },
      { label: 'Reddit', url: 'https://www.reddit.com' },
      { label: 'GitHub', url: 'https://github.com' },
      { label: 'HN', url: 'https://news.ycombinator.com' },
    ];

    const GAMES = [
      { label: '2048', url: 'https://play2048.co' },
      { label: 'Tetris', url: 'https://tetris.com/play-tetris' },
      { label: 'Wordle', url: 'https://www.nytimes.com/games/wordle' },
      { label: 'Chess', url: 'https://www.chess.com/play/computer' },
      { label: 'Pac-Man', url: 'https://www.google.com/logos/2010/pacman10-i.html' },
      { label: 'Sudoku', url: 'https://sudoku.com' },
      { label: 'Snake', url: 'https://playsnake.org' },
      { label: 'Minesweeper', url: 'https://minesweeper.online' },
    ];

    function createTab(url) {
      if (url) url = enforceHttps(url);
      const id = ++tabCounter;
      const tab = { id, url: url || '', title: url ? new URL(url).hostname : 'New Tab', history: url ? [url] : [], historyIndex: url ? 0 : -1 };
      tabs.push(tab);

      // Tab element
      const tabEl = document.createElement('div');
      tabEl.className = 'tab';
      tabEl.dataset.id = id;
      tabEl.draggable = true;
      tabEl.innerHTML = `
        <img class="tab-favicon" src="" alt="">
        <span class="tab-title">${tab.title}</span>
        <span class="tab-close"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M5.172 8L1.086 3.914 3.914 1.086 8 5.172l4.086-4.086 2.828 2.828L10.828 8l4.086 4.086-2.828 2.828L8 10.828l-4.086 4.086-2.828-2.828L5.172 8Z"/></svg></span>
      `;
      tabBar.insertBefore(tabEl, newTabBtn);

      tabEl.addEventListener('click', (e) => {
        if (e.target.closest('.tab-close')) {
          closeTab(id);
        } else {
          activateTab(id);
        }
      });

      // Panel
      const panel = document.createElement('div');
      panel.className = 'tab-panel';
      panel.dataset.id = id;

      if (url) {
        const bar = document.createElement('div');
        bar.className = 'loading-bar active';
        panel.appendChild(bar);
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-forms allow-same-origin allow-popups allow-modals';
        iframe.src = proxyUrl(url);
        attachIframeListener(iframe, id);
        panel.appendChild(iframe);
      } else {
        panel.innerHTML = buildLanding();
      }

      content.appendChild(panel);
      activateTab(id);
      saveTabState();
      return id;
    }

    function extractRealUrl(proxySrc) {
      try {
        const u = new URL(proxySrc, location.origin);
        if (u.pathname.startsWith('/proxy/')) {
          return decodeURIComponent(u.pathname.slice('/proxy/'.length));
        }
      } catch {}
      return null;
    }

    function attachIframeListener(iframe, tabId) {
      let hasLoaded = false;
      iframe.addEventListener('load', () => {
        // Hide loading bar
        const panel = content.querySelector(`.tab-panel[data-id="${tabId}"]`);
        if (panel) {
          const bar = panel.querySelector('.loading-bar');
          if (bar) bar.classList.remove('active');
        }

        let iframeLoc = '';
        try { iframeLoc = iframe.contentWindow.location.href; } catch {}

        // If the page closed itself (navigated to about:blank after initial load), close the tab
        if (hasLoaded && (!iframeLoc || iframeLoc === 'about:blank')) {
          closeTab(tabId);
          return;
        }
        hasLoaded = true;

        let realUrl = null;
        try {
          realUrl = extractRealUrl(iframe.contentWindow.location.href);
        } catch {
          // cross-origin — fall back to the src attribute
          realUrl = extractRealUrl(iframe.src);
        }
        if (!realUrl) return;

        const tab = tabs.find(t => t.id === tabId);
        if (!tab) return;

        tab.url = realUrl;
        try { tab.title = new URL(realUrl).hostname; } catch { tab.title = realUrl; }

        const tabEl = tabBar.querySelector(`.tab[data-id="${tabId}"]`);
        if (tabEl) tabEl.querySelector('.tab-title').textContent = tab.title;

        if (tabId === activeTabId) {
          urlInput.value = realUrl;
        }
      });
    }

    function buildLanding() {
      const shortcuts = SHORTCUTS.map(s =>
        `<div class="shortcut" data-url="${s.url}">${s.label}</div>`
      ).join('');
      const games = GAMES.map(g =>
        `<div class="shortcut" data-url="${g.url}">${g.label}</div>`
      ).join('');
      const bm = loadBookmarks();
      const bookmarksHtml = bm.length
        ? `<div class="bookmarks-grid">${bm.map(b =>
            `<div class="bookmark-item" data-url="${b.url.replace(/"/g, '&quot;')}">
              <span class="bookmark-item-title">${b.title.replace(/</g, '&lt;')}</span>
              <span class="bookmark-item-remove" data-remove-url="${b.url.replace(/"/g, '&quot;')}"><svg width="8" height="8" viewBox="0 0 16 16" fill="currentColor"><path d="M5.172 8L1.086 3.914 3.914 1.086 8 5.172l4.086-4.086 2.828 2.828L10.828 8l4.086 4.086-2.828 2.828L8 10.828l-4.086 4.086-2.828-2.828L5.172 8Z"/></svg></span>
            </div>`
          ).join('')}</div>`
        : '<div class="bookmarks-empty">Click the star in the URL bar to save pages here.</div>';
      return `
        <div class="landing">
          <img class="landing-logo" src="/drift.svg" alt="Drift">
          <h2>Where to?</h2>
          <p>Enter a URL in the bar above to browse through Drift. Your traffic is routed through the proxy.</p>
          <div class="landing-section">
            <div class="landing-section-label">Bookmarks</div>
            ${bookmarksHtml}
          </div>
          <div class="landing-section">
            <div class="landing-section-label">Quick links</div>
            <div class="shortcuts">${shortcuts}</div>
          </div>
          <div class="landing-section">
            <div class="landing-section-label">Games</div>
            <div class="shortcuts">${games}</div>
          </div>
        </div>
      `;
    }

    function activateTab(id) {
      activeTabId = id;

      document.querySelectorAll('.tab').forEach(t =>
        t.classList.toggle('active', Number(t.dataset.id) === id)
      );
      document.querySelectorAll('.tab-panel').forEach(p =>
        p.classList.toggle('active', Number(p.dataset.id) === id)
      );

      const tab = tabs.find(t => t.id === id);
      if (tab) {
        urlInput.value = tab.url;
      }
      updateNavButtons();
      updateBookmarkBtn();
    }

    function closeTab(id) {
      const idx = tabs.findIndex(t => t.id === id);
      if (idx === -1) return;

      tabs.splice(idx, 1);
      tabBar.querySelector(`.tab[data-id="${id}"]`)?.remove();
      content.querySelector(`.tab-panel[data-id="${id}"]`)?.remove();

      if (tabs.length === 0) {
        if (closeWithLastTab) {
          activeTabId = null;
          urlInput.value = '';
        } else {
          createTab();
        }
      } else if (activeTabId === id) {
        const next = tabs[Math.min(idx, tabs.length - 1)];
        activateTab(next.id);
      }
      saveTabState();
    }

    // ─── Tab drag-to-reorder ───
    let dragTabId = null;

    tabBar.addEventListener('dragstart', (e) => {
      const tabEl = e.target.closest('.tab');
      if (!tabEl) return;
      dragTabId = Number(tabEl.dataset.id);
      tabEl.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });

    tabBar.addEventListener('dragend', (e) => {
      const tabEl = e.target.closest('.tab');
      if (tabEl) tabEl.classList.remove('dragging');
      tabBar.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('drag-over-left', 'drag-over-right');
      });
      dragTabId = null;
    });

    tabBar.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.target.closest('.tab');
      if (!target || Number(target.dataset.id) === dragTabId) return;
      const rect = target.getBoundingClientRect();
      const mid = rect.left + rect.width / 2;
      target.classList.toggle('drag-over-left', e.clientX < mid);
      target.classList.toggle('drag-over-right', e.clientX >= mid);
    });

    tabBar.addEventListener('dragleave', (e) => {
      const target = e.target.closest('.tab');
      if (target) target.classList.remove('drag-over-left', 'drag-over-right');
    });

    tabBar.addEventListener('drop', (e) => {
      e.preventDefault();
      const target = e.target.closest('.tab');
      if (!target || dragTabId === null) return;
      const targetId = Number(target.dataset.id);
      if (targetId === dragTabId) return;

      const dragEl = tabBar.querySelector(`.tab[data-id="${dragTabId}"]`);
      if (!dragEl) return;

      // Determine insert position based on cursor side
      const rect = target.getBoundingClientRect();
      const before = e.clientX < rect.left + rect.width / 2;
      if (before) {
        tabBar.insertBefore(dragEl, target);
      } else {
        tabBar.insertBefore(dragEl, target.nextSibling);
      }

      // Sync the tabs array to match the new DOM order
      const orderedIds = [...tabBar.querySelectorAll('.tab')].map(t => Number(t.dataset.id));
      tabs.sort((a, b) => orderedIds.indexOf(a.id) - orderedIds.indexOf(b.id));

      // Clean up visual indicators
      tabBar.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('drag-over-left', 'drag-over-right');
      });
    });

    function updateNavButtons() {
      const tab = tabs.find(t => t.id === activeTabId);
      backBtn.disabled = !tab || tab.historyIndex <= 0;
      fwdBtn.disabled = !tab || tab.historyIndex >= tab.history.length - 1;
    }

    function pushHistory(tab, url) {
      if (tab.historyIndex >= 0 && tab.history[tab.historyIndex] === url) return;
      tab.history = tab.history.slice(0, tab.historyIndex + 1);
      tab.history.push(url);
      tab.historyIndex = tab.history.length - 1;
      updateNavButtons();
    }

    function loadInCurrentTab(url) {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return;

      tab.url = url;
      try { tab.title = new URL(url).hostname; } catch { tab.title = url; }

      const tabEl = tabBar.querySelector(`.tab[data-id="${activeTabId}"]`);
      if (tabEl) tabEl.querySelector('.tab-title').textContent = tab.title;

      const panel = content.querySelector(`.tab-panel[data-id="${activeTabId}"]`);
      if (panel) {
        panel.innerHTML = '';
        const bar = document.createElement('div');
        bar.className = 'loading-bar active';
        panel.appendChild(bar);
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-forms allow-same-origin allow-popups allow-modals';
        iframe.src = proxyUrl(url);
        attachIframeListener(iframe, activeTabId);
        panel.appendChild(iframe);
      }

      urlInput.value = url;
    }

    function navigateCurrentTab(url) {
      url = enforceHttps(url);
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab) pushHistory(tab, url);
      loadInCurrentTab(url);
    }

    function isUrl(str) {
      // Has a protocol
      if (/^https?:\/\//i.test(str)) return true;
      // Looks like a domain (has a dot, no spaces)
      if (/^[^\s]+\.[a-z]{2,}/i.test(str)) return true;
      // localhost or IP
      if (/^(localhost|(\d{1,3}\.){3}\d{1,3})(:\d+)?/i.test(str)) return true;
      return false;
    }

    // Form submit
    urlForm.addEventListener('submit', (e) => {
      e.preventDefault();
      let input = urlInput.value.trim();
      if (!input) return;

      let url;
      if (isUrl(input)) {
        url = /^https?:\/\//i.test(input) ? input : 'https://' + input;
      } else {
        // Search query — route to selected search engine
        url = SEARCH_ENGINES[currentSearchEngine].url + encodeURIComponent(input);
      }

      urlInput.value = url;
      navigateCurrentTab(url);
    });

    // New tab button
    newTabBtn.addEventListener('click', () => {
      createTab();
      urlInput.focus();
      urlInput.select();
    });

    // Bookmark button
    bookmarkBtn.addEventListener('click', toggleBookmark);

    // Shortcut & bookmark clicks (delegated)
    content.addEventListener('click', (e) => {
      // Remove bookmark
      const removeBtn = e.target.closest('.bookmark-item-remove');
      if (removeBtn) {
        e.stopPropagation();
        removeBookmark(removeBtn.dataset.removeUrl);
        return;
      }
      // Navigate bookmark
      const bmItem = e.target.closest('.bookmark-item');
      if (bmItem) {
        const url = bmItem.dataset.url;
        urlInput.value = url;
        navigateCurrentTab(url);
        return;
      }
      // Navigate shortcut
      const shortcut = e.target.closest('.shortcut');
      if (shortcut) {
        const url = shortcut.dataset.url;
        urlInput.value = url;
        navigateCurrentTab(url);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && settingsPanel.classList.contains('open')) {
        e.preventDefault();
        closeSettings();
        return;
      }
      if ((e.ctrlKey || e.metaKey) && e.key === ',') {
        e.preventDefault();
        settingsPanel.classList.contains('open') ? closeSettings() : openSettings();
        return;
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 't') {
        e.preventDefault();
        createTab();
        urlInput.focus();
        urlInput.select();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'w') {
        e.preventDefault();
        if (activeTabId) closeTab(activeTabId);
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        e.preventDefault();
        urlInput.focus();
        urlInput.select();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault();
        toggleBookmark();
      }
      if (e.altKey && e.key === 'ArrowLeft') {
        e.preventDefault();
        backBtn.click();
      }
      if (e.altKey && e.key === 'ArrowRight') {
        e.preventDefault();
        fwdBtn.click();
      }
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Delete') {
        e.preventDefault();
        clearSessionData();
      }
    });

    // Listen for messages from proxied pages
    window.addEventListener('message', (e) => {
      if (!e.data) return;

      // Handle tab close requests from proxied pages
      if (e.data.type === 'drift-close') {
        if (activeTabId) closeTab(activeTabId);
        return;
      }

      if (e.data.type !== 'drift-meta') return;
      const { title, favicon, url } = e.data;

      // Find which tab this iframe belongs to
      const tab = tabs.find(t => {
        if (!url) return false;
        // Match by URL (the final URL after redirects)
        return t.url === url || new URL(t.url).origin === new URL(url).origin;
      }) || tabs.find(t => t.id === activeTabId);

      if (!tab) return;

      if (title) {
        tab.title = title;
        const tabEl = tabBar.querySelector(`.tab[data-id="${tab.id}"]`);
        if (tabEl) tabEl.querySelector('.tab-title').textContent = title;
      }

      if (url) {
        tab.url = url;
        if (tab.id === activeTabId) {
          urlInput.value = url;
          updateBookmarkBtn();
        }
        if (!tab._navBack) pushHistory(tab, url);
        tab._navBack = false;
        saveTabState();
      }

      if (favicon) {
        tab.favicon = favicon;
        const tabEl = tabBar.querySelector(`.tab[data-id="${tab.id}"]`);
        if (tabEl) {
          const img = tabEl.querySelector('.tab-favicon');
          img.src = `/proxy/${encodeURIComponent(favicon)}`;
          img.onload = () => img.classList.add('loaded');
          img.onerror = () => img.classList.remove('loaded');
        }
      }
    });

    // Back / Forward buttons
    backBtn.addEventListener('click', () => {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || tab.historyIndex <= 0) return;
      tab._navBack = true;
      tab.historyIndex--;
      loadInCurrentTab(tab.history[tab.historyIndex]);
      updateNavButtons();
    });

    fwdBtn.addEventListener('click', () => {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || tab.historyIndex >= tab.history.length - 1) return;
      tab._navBack = true;
      tab.historyIndex++;
      loadInCurrentTab(tab.history[tab.historyIndex]);
      updateNavButtons();
    });

    // Start with tabs (restore previous or new)
    (function initTabs() {
      if (restoreTabsOnStartup) {
        try {
          const saved = JSON.parse(localStorage.getItem('drift-saved-tabs')) || [];
          if (saved.length > 0) {
            saved.forEach(t => createTab(t.url));
            urlInput.focus();
            return;
          }
        } catch {}
      }
      createTab();
      urlInput.focus();
    })();

    window.addEventListener('beforeunload', saveTabState);
  </script>
</body>
</html>
